---
title: "dbem_test_runs"
author: "Juliano Palacios"
date: "25/07/2023"
output: pdf_document
---


```{r setup, include = F}

source(here::here('./Functions/function_list.R'))

load_pkg(c(
  # For data wrangling
  "tidyverse",
  "janitor",
  # For collaborative ease
  "here",
  # for spatial analysis
  "sf"
  ))

# For grid e
# Fix new updates of sf package
sf::sf_use_s2(use_s2 = FALSE)

select <- dplyr::select

```


# Test first run batch

We ran 40 species using the GFDL26 Pre Industrial with F1 and the MPA grid (RC6GFDLPIF1MPA)

```{r test_initial_runs}

# Read species list
# exploited_species_list <- read.csv("/Volumes/Enterprise/Data/SAU/exploited_species_list.csv")

# Read runs
# runs <- list.files("/Volumes/Enterprise/Data/toe_mpa/dbem_runs/RC6GFDLPIF1MPA",full.names = T)

# MPA grid
grid_mpa <- read_csv("../Data/grid_all_mpas.csv") %>% 
  select(index = seq,
         status,
         prop) %>% 
  mutate(status = ifelse(is.na(status),"open",status))

# DBEM coordinates

coods_dbem <- MyFunctions::my_data("dbem_coords")

# Load DBEM
dbem_df <- load_dbem("C6GFDL85F1MPAT3", cat = "Catch")

# sau_sf <- my_sf("SAU",simple = 100)

```



```{r}

dbem_df %>% 
  group_by(year) %>% 
  filter(year >1852) %>% 
  summarise(value = sum(value,na.rm = T)) %>% 
  ggplot() +
  geom_line(
    aes(
      x = as.numeric(year),
      y = value
    )
  )

```



```{r}

dbem_df %>% 
  filter(year == 2000) %>% 
  filter(!is.na(value)) %>%
  left_join(grid_mpa) %>% 
  left_join(coods_dbem) %>%
  # View()
  ggplot() +
  geom_tile(
    aes(
      x = lon,
      y = lat,
      color = value,
      fill = value
    )
  ) +
  my_land_map() +
  coord_sf(xlim = c(15,30),
           ylim = c(-40,-30)
           ) +
  facet_wrap(~status) +
  scale_fill_viridis_c() +
  scale_color_viridis_c()
  

```

